#!/usr/bin/env bash
#
# OpenCode Pantheon Installer
# Multi-agent configuration for OpenCode
#
# Usage:
#   curl -fsSL https://raw.githubusercontent.com/simonwep/opencode-pantheon/main/install | bash
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Default values
REPO_URL="https://github.com/simonwep/opencode-pantheon"
REPO_BRANCH="main"
USE_DEFAULTS=true
CUSTOM_MODELS=""
INSTALL_TYPE="opencode"  # "opencode" or "kilo"

# ============================================
# OS Detection
# ============================================

detect_os() {
    case "$(uname -s)" in
        Linux*)     OS="linux" ;;
        Darwin*)    OS="macos" ;;
        CYGWIN*)    OS="windows" ;;
        MINGW*)     OS="windows" ;;
        MSYS*)      OS="windows" ;;
        *)          OS="linux" ;;
    esac
    
    # Check for WSL
    if [[ "$OS" == "linux" ]] && grep -qi microsoft /proc/version 2>/dev/null; then
        OS="wsl"
    fi
    
    echo "$OS"
}

# ============================================
# Config Path Detection
# ============================================

get_config_dir() {
    local install_type="$1"
    local os="$2"
    
    case "$os" in
        linux|wsl|macos)
            if [[ "$install_type" == "kilo" ]]; then
                if [[ -n "$XDG_CONFIG_HOME" ]]; then
                    echo "$XDG_CONFIG_HOME/kilo"
                else
                    echo "$HOME/.config/kilo"
                fi
            else
                if [[ -n "$XDG_CONFIG_HOME" ]]; then
                    echo "$XDG_CONFIG_HOME/opencode"
                else
                    echo "$HOME/.config/opencode"
                fi
            fi
            ;;
        windows)
            if [[ "$install_type" == "kilo" ]]; then
                echo "$APPDATA/kilo"
            else
                echo "$APPDATA/opencode"
            fi
            ;;
        *)
            if [[ "$install_type" == "kilo" ]]; then
                echo "$HOME/.config/kilo"
            else
                echo "$HOME/.config/opencode"
            fi
            ;;
    esac
}

# ============================================
# Argument Parsing (for backward compatibility)
# ============================================

parse_args() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --defaults|-d)
                USE_DEFAULTS=true
                shift
                ;;
            --models|-m)
                USE_DEFAULTS=false
                CUSTOM_MODELS="$2"
                shift 2
                ;;
            --non-interactive|-y)
                # Keep using defaults in non-interactive mode
                shift
                ;;
            --help|-h)
                show_help
                exit 0
                ;;
            *)
                echo -e "${RED}Unknown option: $1${NC}"
                show_help
                exit 1
                ;;
        esac
    done
}

show_help() {
    cat << EOF
OpenCode Pantheon Installer

Usage:
  curl -fsSL <url>/install | bash

Options:
  -d, --defaults          Use default models (default behavior)
  -m, --models MODELS     Specify custom models (format: agent=model,agent=model)
  -y, --non-interactive   Non-interactive mode (use defaults)
  -h, --help              Show this help message

Examples:
  # Interactive installation (will prompt for choices)
  curl -fsSL https://raw.githubusercontent.com/simonwep/opencode-pantheon/main/install | bash

  # Use default models
  curl -fsSL ... | bash -s -- --defaults

  # Specify custom models
  curl -fsSL ... | bash -s -- --models "orchestrator=opencode/gpt-5.1-codex,fixer=opencode/gemini-3-flash"
EOF
}

# ============================================
# Interactive Prompts
# ============================================

prompt_install_type() {
    echo -e "\n${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}  Installation Type${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo ""
    echo -e "  ${BLUE}1)${NC} OpenCode      → Config: ~/.config/opencode"
    echo -e "  ${BLUE}2)${NC} KiloCode CLI   → Config: ~/.config/kilo"
    echo ""
    echo -e "  The only difference is where config files are stored."
    echo ""
    
    while true; do
        read -rp "$(echo -e "${GREEN}Choose [1-2, default: 1]: ${NC}")" choice
        choice="${choice:-1}"
        
        case "$choice" in
            1)
                INSTALL_TYPE="opencode"
                break
                ;;
            2)
                INSTALL_TYPE="kilo"
                break
                ;;
            *)
                echo -e "${YELLOW}Please enter 1 or 2${NC}"
                ;;
        esac
    done
    
    echo -e "${GREEN}Selected: $INSTALL_TYPE${NC}"
}

prompt_model_choice() {
    echo -e "\n${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}  Model Selection${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo ""
    echo -e "  ${BLUE}1)${NC} Use default models"
    echo -e "  ${BLUE}2)${NC} Specify custom models"
    echo ""
    
    while true; do
        read -rp "$(echo -e "${GREEN}Choose [1-2, default: 1]: ${NC}")" choice
        choice="${choice:-1}"
        
        case "$choice" in
            1)
                USE_DEFAULTS=true
                break
                ;;
            2)
                USE_DEFAULTS=false
                break
                ;;
            *)
                echo -e "${YELLOW}Please enter 1 or 2${NC}"
                ;;
        esac
    done
    
    if [[ "$USE_DEFAULTS" == "false" ]]; then
        echo ""
        echo -e "${BLUE}Enter models in format: agent=model,agent=model${NC}"
        echo -e "${YELLOW}Example: orchestrator=opencode/glm-5,fixer=opencode/minimax-m2.5${NC}"
        echo ""
        read -rp "$(echo -e "${GREEN}Models: ${NC}")" CUSTOM_MODELS
    fi
}

# ============================================
# Get Available Models from OpenCode
# ============================================

get_available_models() {
    if command -v opencode &> /dev/null; then
        opencode models --list 2>/dev/null | grep -E "^[a-z]" | head -50 || echo ""
    else
        echo ""
    fi
}

# ============================================
# Model Selection
# ============================================

select_models() {
    local available_models
    available_models=$(get_available_models)
    
    # Default models
    local defaults
    defaults=$(cat << 'EOF'
orchestrator=opencode/glm-5
explorer=opencode/minimax-m2.5
oracle=opencode/claude-sonnet-4-6
librarian=opencode/gemini-3-flash
designer=opencode/gemini-3-flash
fixer=opencode/minimax-m2.5
mapper=opencode/minimax-m2.5
default=opencode/minimax-m2.5
EOF
)
    
    # Parse custom models if provided
    if [[ -n "$CUSTOM_MODELS" ]]; then
        echo "$CUSTOM_MODELS" | tr ',' '\n' | while read -r pair; do
            agent="${pair%%=*}"
            model="${pair#*=}"
            echo "${agent}=${model}"
        done
        return
    fi
    
    # Use defaults
    echo "$defaults"
}

# ============================================
# Generate Config
# ============================================

generate_config() {
    local models="$1"
    local config_dir="$2"
    local install_type="$3"
    
    # Adjust model prefix based on install type
    local model_prefix="opencode"
    if [[ "$install_type" == "kilo" ]]; then
        model_prefix="kilo"
    fi
    
    template=$(cat << TPLATE
{
  "\$schema": "https://opencode.ai/config.json",
  "model": "${model_prefix}/minimax-minimax-m2.5",
  "mcp": {
    "websearch": {
      "type": "remote",
      "url": "https://mcp.exa.ai/mcp?tools=web_search_exa",
      "headers": {
        "x-api-key": "{env:EXA_API_KEY}"
      }
    },
    "context7": {
      "type": "remote",
      "url": "https://mcp.context7.com/mcp",
      "headers": {
        "CONTEXT7_API_KEY": "{env:CONTEXT7_API_KEY}"
      }
    },
    "grep_app": {
      "type": "remote",
      "url": "https://mcp.grep.app"
    }
  },
  "tools": {
    "websearch_*": false,
    "context7_*": false,
    "grep_app_*": false
  },
  "agent": {
    "orchestrator": {
      "description": "AI coding orchestrator that delegates tasks to specialist agents for optimal quality, speed, and cost",
      "mode": "primary",
      "model": "${model_prefix}/glm-5",
      "temperature": 0.1,
      "prompt": "{file:./agents/orchestrator.md}",
      "tools": {
        "task": true,
        "skill": true,
        "bash": true,
        "read": true,
        "glob": true,
        "grep": true,
        "websearch_*": true
      },
      "permission": {
        "question": "allow",
        "skill": {
          "*": "allow"
        },
        "task": {
          "*": "allow"
        }
      }
    },
    "explorer": {
      "description": "Fast codebase search and pattern matching. Use for finding files, locating code patterns, and answering 'where is X?' questions.",
      "mode": "subagent",
      "model": "${model_prefix}/minimax-minimax-m2.5",
      "temperature": 0.1,
      "prompt": "{file:./agents/explorer.md}",
      "permission": {
        "task": {}
      },
      "tools": {
        "grep": true,
        "glob": true,
        "ast_grep_search": true,
        "read": true,
        "write": false,
        "edit": false,
        "bash": false
      }
    },
    "oracle": {
      "description": "Strategic technical advisor. Use for architecture decisions, complex debugging, code review, and engineering guidance.",
      "mode": "subagent",
      "model": "${model_prefix}/anthropic-claude-sonnet-4.6",
      "temperature": 0.1,
      "prompt": "{file:./agents/oracle.md}",
      "permission": {
        "task": {}
      },
      "tools": {
        "read": true,
        "grep": true,
        "glob": true,
        "lsp_goto_definition": true,
        "lsp_find_references": true,
        "write": false,
        "edit": false,
        "bash": false
      }
    },
    "librarian": {
      "description": "External documentation and library research. Use for official docs lookup, GitHub examples, and understanding library internals.",
      "mode": "subagent",
      "model": "${model_prefix}/google-gemini-3-flash-preview",
      "temperature": 0.1,
      "prompt": "{file:./agents/librarian.md}",
      "permission": {
        "task": {}
      },
      "tools": {
        "websearch_*": true,
        "context7_*": true,
        "grep_app_*": true
      }
    },
    "designer": {
      "description": "UI/UX design and implementation. Use for styling, responsive design, component architecture and visual polish.",
      "mode": "subagent",
      "model": "${model_prefix}/google-gemini-3-flash-preview",
      "temperature": 0.7,
      "prompt": "{file:./agents/designer.md}",
      "permission": {
        "task": {
          "explorer": "allow"
        }
      },
      "tools": {
        "read": true,
        "write": true,
        "edit": true,
        "glob": true,
        "grep": true
      }
    },
    "fixer": {
      "description": "Fast implementation specialist. Receives complete context and task spec, executes code changes efficiently.",
      "mode": "subagent",
      "model": "${model_prefix}/minimax-minimax-m2.5",
      "temperature": 0.2,
      "prompt": "{file:./agents/fixer.md}",
      "permission": {
        "task": {
          "explorer": "allow"
        }
      },
      "tools": {
        "read": true,
        "write": true,
        "edit": true,
        "glob": true,
        "grep": true,
        "bash": true,
        "lsp_diagnostics": true
      }
    },
    "mapper": {
      "description": "Repository mapper for cartography. Creates and updates codemap.md files to document codebase architecture.",
      "mode": "subagent",
      "model": "${model_prefix}/minimax-minimax-m2.5",
      "temperature": 0.1,
      "prompt": "{file:./agents/mapper.md}",
      "permission": {
        "task": {}
      },
      "tools": {
        "read": true,
        "write": true,
        "edit": true,
        "glob": true,
        "grep": true
      }
    }
  }
}
TPLATE
)
    
    echo "$template"
}

# ============================================
# Main Installation
# ============================================

install() {
    local os config_dir models
    
    # Detect OS
    os=$(detect_os)
    echo -e "${GREEN}Detected OS: ${os}${NC}"
    
    # Parse command line args first (for backward compatibility)
    parse_args "$@"
    
    # Interactive prompts if not set via args
    if [[ -z "$CUSTOM_MODELS" ]]; then
        prompt_install_type
        prompt_model_choice
    fi
    
    # Get config directory
    config_dir=$(get_config_dir "$INSTALL_TYPE" "$os")
    echo -e "${GREEN}Config directory: ${config_dir}${NC}"
    
    # Check if OpenCode/Kilo is installed
    if [[ "$INSTALL_TYPE" == "kilo" ]]; then
        if ! command -v kilo &> /dev/null; then
            echo -e "${YELLOW}Warning: KiloCode CLI is not installed or not in PATH${NC}"
            echo -e "${YELLOW}Install KiloCode CLI first${NC}"
        fi
    else
        if ! command -v opencode &> /dev/null; then
            echo -e "${YELLOW}Warning: OpenCode is not installed or not in PATH${NC}"
            echo -e "${YELLOW}Install OpenCode first: https://opencode.ai${NC}"
        fi
    fi
    
    # Backup existing config
    if [[ -d "$config_dir" ]]; then
        local backup_dir="${config_dir}.backup.$(date +%Y%m%d_%H%M%S)"
        echo -e "${YELLOW}Backing up existing config to: ${backup_dir}${NC}"
        mv "$config_dir" "$backup_dir"
    fi
    
    # Create config directory
    mkdir -p "$config_dir"
    
    # Download repo
    echo -e "${GREEN}Downloading OpenCode Pantheon...${NC}"
    
    if command -v git &> /dev/null; then
        git clone --depth 1 --branch "$REPO_BRANCH" "$REPO_URL" /tmp/opencode-pantheon 2>/dev/null || {
            echo -e "${RED}Failed to clone repository${NC}"
            exit 1
        }
        
        # Copy files (excluding .git and install script)
        cp -r /tmp/opencode-pantheon/{agents,skills} "$config_dir/" 2>/dev/null || true
        rm -rf /tmp/opencode-pantheon
    else
        echo -e "${RED}Git is required for installation${NC}"
        exit 1
    fi
    
    # Select models
    models=$(select_models)
    
    # Generate config
    echo -e "${GREEN}Generating configuration...${NC}"
    generate_config "$models" "$config_dir" "$INSTALL_TYPE" > "$config_dir/opencode.json"
    
    # Success message
    echo -e "\n${GREEN}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}  ✓ OpenCode Pantheon installed successfully!${NC}"
    echo -e "${GREEN}═══════════════════════════════════════════════════════════${NC}"
    echo ""
    echo -e "Config location: ${CYAN}${config_dir}${NC}"
    echo ""
    echo -e "${BLUE}Agents:${NC}"
    echo "  • orchestrator - Primary agent with delegation"
    echo "  • explorer     - Codebase search"
    echo "  • oracle       - Architecture advisor"
    echo "  • librarian    - Documentation research"
    echo "  • designer     - UI/UX specialist"
    echo "  • fixer        - Implementation specialist"
    echo "  • mapper       - Repository mapping"
    echo ""
    echo -e "${BLUE}MCP Servers:${NC}"
    echo "  • websearch  - Web search (set EXA_API_KEY)"
    echo "  • context7   - Docs lookup (set CONTEXT7_API_KEY)"
    echo "  • grep_app   - GitHub code search"
    echo ""
    
    if [[ "$INSTALL_TYPE" == "kilo" ]]; then
        echo -e "${YELLOW}Run 'kilo' to start!${NC}"
    else
        echo -e "${YELLOW}Run 'opencode' to start!${NC}"
    fi
}

# ============================================
# Entry Point
# ============================================

main() {
    echo -e "${CYAN}"
    cat << 'BANNER'
  ____                 _             ____             _   _            
 / _ \ _ __ ___  _ __ | | ___   _   / __ \ _ __ _   _| |_| | ___  ___  
| | | | '_ ` _ \| '_ \| |/ / | | | | |  | | '__| | | | __| |/ _ \/ __| 
| |_| | | | | | | |_) |   <| |_| | | |__| | |  | |_| | |_| |  __/\__ \ 
 \___/|_| |_| |_| .__/|_|\_\\__, |  \____/|_|   \__, |\__|_|\___||___/ 
                 |_|         |___/               |___/                    
BANNER
    echo -e "${NC}"
    
    install "$@"
}

main "$@"
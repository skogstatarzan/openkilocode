#!/usr/bin/env bash
#
# OpenKiloCode Installer
# Multi-agent configuration for OpenCode and KiloCode CLI
#
# Usage:
#   curl -fsSL https://raw.githubusercontent.com/skogstatarzan/openkilocode/main/install | bash
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Default values
REPO_URL="https://github.com/skogstatarzan/openkilocode"
REPO_BRANCH="main"
USE_DEFAULTS=true
CUSTOM_MODELS=""
INSTALL_TYPE="opencode"
EXA_API_KEY=""
CONTEXT7_API_KEY=""

# Global OS variable
OS=""

# Check if running interactively (or can use /dev/tty)
can_interact() {
    # Can interact if stdin is a terminal OR /dev/tty exists and is writable
    [[ -t 0 ]] || (test -t 1 || test -w /dev/tty)
}

# Read with fallback to /dev/tty for piped input
prompt_read() {
    if [[ -t 0 ]]; then
        read -rp "$@"
    else
        read -rp "$@" </dev/tty
    fi
}

# ============================================
# OS Detection
# ============================================

detect_os() {
    case "$(uname -s)" in
        Linux*)     OS="linux" ;;
        Darwin*)    OS="macos" ;;
        CYGWIN*)    OS="windows" ;;
        MINGW*)     OS="windows" ;;
        MSYS*)      OS="windows" ;;
        *)          OS="linux" ;;
    esac
    
    if [[ "$OS" == "linux" ]] && grep -qi microsoft /proc/version 2>/dev/null; then
        OS="wsl"
    fi
    
    echo "$OS"
}

detect_linux_distro() {
    if [[ -f /etc/debian_version ]]; then
        echo "debian"
    elif [[ -f /etc/fedora-release ]]; then
        echo "fedora"
    elif [[ -f /etc/redhat-release ]]; then
        echo "rhel"
    elif command -v apt &> /dev/null; then
        echo "debian"
    elif command -v dnf &> /dev/null; then
        echo "fedora"
    else
        echo "unknown"
    fi
}

get_sed_inplace_flag() {
    if [[ "$(uname -s)" == "Darwin" ]]; then
        echo "-i ''"
    else
        echo "-i"
    fi
}

get_config_dir() {
    local install_type="$1"
    local os="$2"
    
    case "$os" in
        linux|wsl|macos)
            if [[ "$install_type" == "kilo" ]]; then
                if [[ -n "$XDG_CONFIG_HOME" ]]; then
                    echo "$XDG_CONFIG_HOME/kilo"
                else
                    echo "$HOME/.config/kilo"
                fi
            else
                if [[ -n "$XDG_CONFIG_HOME" ]]; then
                    echo "$XDG_CONFIG_HOME/opencode"
                else
                    echo "$HOME/.config/opencode"
                fi
            fi
            ;;
        windows)
            if [[ "$install_type" == "kilo" ]]; then
                if [[ -n "$XDG_CONFIG_HOME" ]]; then
                    echo "$XDG_CONFIG_HOME/kilo"
                else
                    echo "$HOME/.config/kilo"
                fi
            else
                if [[ -n "$XDG_CONFIG_HOME" ]]; then
                    echo "$XDG_CONFIG_HOME/opencode"
                else
                    echo "$HOME/.config/opencode"
                fi
            fi
            ;;
        *)
            if [[ "$install_type" == "kilo" ]]; then
                echo "$HOME/.config/kilo"
            else
                echo "$HOME/.config/opencode"
            fi
            ;;
    esac
}

# ============================================
# Argument Parsing
# ============================================

parse_args() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --defaults|-d)
                USE_DEFAULTS=true
                shift
                ;;
            --models|-m)
                USE_DEFAULTS=false
                CUSTOM_MODELS="$2"
                shift 2
                ;;
            --non-interactive|-y)
                shift
                ;;
            --help|-h)
                show_help
                exit 0
                ;;
            *)
                echo -e "${RED}Unknown option: $1${NC}"
                show_help
                exit 1
                ;;
        esac
    done
}

show_help() {
    cat << EOF
OpenKiloCode Installer

Usage:
  curl -fsSL <url>/install | bash

Options:
  -d, --defaults          Use default models
  -m, --models MODELS     Specify custom models
  -y, --non-interactive   Non-interactive mode
  -h, --help              Show this help message
EOF
}

# ============================================
# Dependency Checking
# ============================================

check_command() {
    command -v "$1" &> /dev/null
}

get_version() {
    local cmd="$1"
    case "$cmd" in
        git)
            git --version 2>/dev/null | awk '{print $3}' || echo "unknown"
            ;;
        node)
            node --version 2>/dev/null || echo "unknown"
            ;;
        npm)
            npm --version 2>/dev/null || echo "unknown"
            ;;
        brew)
            brew --version 2>/dev/null | head -1 | awk '{print $2}' || echo "unknown"
            ;;
        winget)
            winget --version 2>/dev/null | sed 's/v//' || echo "unknown"
            ;;
        choco)
            choco --version 2>/dev/null || echo "unknown"
            ;;
        opencode)
            opencode --version 2>/dev/null || echo "installed"
            ;;
        kilo)
            kilo --version 2>/dev/null || echo "installed"
            ;;
        agent-browser)
            agent-browser --version 2>/dev/null || echo "installed"
            ;;
        *)
            echo "installed"
            ;;
    esac
}

print_status() {
    local name="$1"
    local installed="$2"
    local version="$3"
    local required="$4"
    
    if [[ "$installed" == "true" ]]; then
        printf "  ${GREEN}✓${NC} %-20s %s\n" "$name" "($version)"
    else
        if [[ "$required" == "true" ]]; then
            printf "  ${RED}✗${NC} %-20s %s\n" "$name" "(required)"
        else
            printf "  ${YELLOW}○${NC} %-20s %s\n" "$name" "(optional)"
        fi
    fi
}

# ============================================
# KiloCode Installation Type Detection
# ============================================

# Check if kilo is installed via old method (standalone binary in ~/.kilo/bin/)
is_old_kilo_installation() {
    local kilo_path
    kilo_path=$(command -v kilo 2>/dev/null || echo "")
    
    if [[ -z "$kilo_path" ]]; then
        return 1
    fi
    
    # Check if it's the old standalone binary location
    # Old installer used $HOME/.kilo/bin for all platforms (Linux, macOS, Windows)
    if [[ "$kilo_path" == "$HOME/.kilo/bin/kilo" ]] || [[ "$kilo_path" == "$HOME/.kilo/bin/kilo.exe" ]]; then
        return 0
    fi
    
    # Also check if ~/.kilo/bin/kilo exists as a binary (not symlink to npm)
    local old_kilo_bin="$HOME/.kilo/bin/kilo"
    if [[ -f "$old_kilo_bin" ]] || [[ -f "$old_kilo_bin.exe" ]]; then
        # Check if it's NOT a symlink to node_modules (which would be the new npm install)
        if [[ -L "$old_kilo_bin" ]]; then
            local link_target
            link_target=$(readlink -f "$old_kilo_bin" 2>/dev/null || readlink "$old_kilo_bin" 2>/dev/null || echo "")
            if [[ "$link_target" == *"node_modules"* ]] || [[ "$link_target" == *"@kilocode"* ]]; then
                return 1
            fi
        fi
        # It's a standalone binary
        return 0
    fi
    
    return 1
}

# Check if kilo is installed via new method (npm @kilocode/cli)
is_new_kilo_installation() {
    local kilo_path
    kilo_path=$(command -v kilo 2>/dev/null || echo "")
    
    if [[ -z "$kilo_path" ]]; then
        return 1
    fi
    
    # Check if it's from npm (symlink to node_modules/@kilocode/cli)
    if [[ "$kilo_path" == *"node_modules/@kilocode/cli"* ]]; then
        return 0
    fi
    
    # Check if it's a symlink pointing to @kilocode/cli
    if [[ -L "$kilo_path" ]]; then
        local link_target
        link_target=$(readlink -f "$kilo_path" 2>/dev/null || readlink "$kilo_path" 2>/dev/null || echo "")
        if [[ "$link_target" == *"@kilocode/cli"* ]]; then
            return 0
        fi
    fi
    
    # Check if npm global has @kilocode/cli
    if npm list -g @kilocode/cli 2>/dev/null | grep -q "@kilocode/cli"; then
        return 0
    fi
    
    return 1
}

# Get old kilo installation directory
get_old_kilo_dir() {
    # Old installer used $HOME/.kilo for all platforms
    echo "$HOME/.kilo"
}

# Remove old kilo installation
remove_old_kilo_installation() {
    local old_dir
    old_dir=$(get_old_kilo_dir)
    
    echo -e "\n${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}  Removing Old KiloCode Installation${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo ""
    echo -e "${YELLOW}Found old KiloCode installation (standalone binary).${NC}"
    echo -e "${YELLOW}This will be removed and replaced with the new npm-based version.${NC}"
    echo ""
    echo -e "  Old location: ${BLUE}${old_dir}${NC}"
    echo ""
    
    if [[ -d "$old_dir" ]]; then
        echo -e "${BLUE}Removing old installation...${NC}"
        rm -rf "$old_dir"
        echo -e "${GREEN}✓ Old installation removed${NC}"
    fi
    
    # Refresh PATH cache
    hash -r 2>/dev/null || true
}

# ============================================
# Package Manager Detection
# ============================================

detect_package_manager() {
    case "$OS" in
        macos)
            if check_command brew; then
                echo "brew"
            else
                echo "none"
            fi
            ;;
        linux|wsl)
            local distro
            distro=$(detect_linux_distro)
            case "$distro" in
                debian)
                    echo "apt"
                    ;;
                fedora|rhel)
                    echo "dnf"
                    ;;
                *)
                    if check_command apt; then
                        echo "apt"
                    elif check_command dnf; then
                        echo "dnf"
                    else
                        echo "none"
                    fi
                    ;;
            esac
            ;;
        windows)
            if check_command winget; then
                echo "winget"
            elif check_command choco; then
                echo "choco"
            else
                echo "none"
            fi
            ;;
        *)
            echo "none"
            ;;
    esac
}

# ============================================
# Installation Functions
# ============================================

install_homebrew() {
    echo -e "\n${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}  Homebrew Installation Required${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo ""
    echo -e "${YELLOW}Homebrew is required to install packages on macOS.${NC}"
    echo ""
    echo "Please open a new terminal window and run:"
    echo ""
    echo -e "  ${BOLD}/bin/bash -c \"\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\"${NC}"
    echo ""
    echo "Follow the prompts:"
    echo "  1. Press RETURN when asked"
    echo "  2. Enter your password when asked"
    echo "  3. Wait for installation to complete"
    echo "  4. Run any 'eval' commands shown at the end"
    echo ""
    prompt_read "Press Enter when Homebrew installation is complete... "
    
    if check_command brew; then
        echo -e "${GREEN}✓ Homebrew detected!${NC}"
        return 0
    else
        echo -e "${RED}Homebrew still not found. Please complete the installation and restart this script.${NC}"
        return 1
    fi
}

install_chocolatey() {
    echo -e "\n${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}  Chocolatey Installation Required${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo ""
    echo -e "${YELLOW}Neither winget nor Chocolatey is installed.${NC}"
    echo ""
    echo "Please open PowerShell as Administrator and run:"
    echo ""
    echo -e "  ${BOLD}Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))${NC}"
    echo ""
    prompt_read "Press Enter when Chocolatey installation is complete... "
    
    if check_command choco; then
        echo -e "${GREEN}✓ Chocolatey detected!${NC}"
        return 0
    else
        echo -e "${RED}Chocolatey still not found.${NC}"
        return 1
    fi
}

install_git() {
    local pkg_manager="$1"
    
    echo -e "${BLUE}Installing Git...${NC}"
    
    case "$pkg_manager" in
        brew)
            brew install git
            ;;
        apt)
            sudo apt update && sudo apt install -y git
            ;;
        dnf)
            sudo dnf install -y git
            ;;
        winget)
            winget install --id Git.Git --accept-source-agreements --accept-package-agreements
            ;;
        choco)
            choco install git -y
            ;;
        *)
            echo -e "${RED}No package manager available to install Git.${NC}"
            return 1
            ;;
    esac
    
    if check_command git; then
        echo -e "${GREEN}✓ Git installed successfully${NC}"
        return 0
    else
        echo -e "${RED}Failed to install Git${NC}"
        return 1
    fi
}

install_nodejs() {
    local pkg_manager="$1"
    
    echo -e "${BLUE}Installing Node.js and npm...${NC}"
    
    case "$pkg_manager" in
        brew)
            brew install node
            ;;
        apt)
            sudo apt update && sudo apt install -y nodejs npm
            ;;
        dnf)
            sudo dnf install -y nodejs npm
            ;;
        winget)
            winget install --id OpenJS.NodeJS.LTS --accept-source-agreements --accept-package-agreements
            ;;
        choco)
            choco install nodejs -y
            ;;
        *)
            echo -e "${RED}No package manager available to install Node.js.${NC}"
            return 1
            ;;
    esac
    
    if [[ "$OS" == "windows" ]]; then
        export PATH="$PATH:/c/Program Files/nodejs"
    fi
    
    if check_command npm; then
        echo -e "${GREEN}✓ Node.js and npm installed successfully${NC}"
        return 0
    else
        echo -e "${RED}Failed to install Node.js${NC}"
        return 1
    fi
}

install_agent_browser() {
    echo -e "${BLUE}Installing agent-browser...${NC}"
    
    npm install -g agent-browser
    agent-browser install 2>/dev/null || true
    
    if check_command agent-browser; then
        echo -e "${GREEN}✓ agent-browser installed successfully${NC}"
        return 0
    else
        echo -e "${YELLOW}agent-browser installed but may need additional setup${NC}"
        return 0
    fi
}

install_opencode() {
    echo -e "\n${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}  Installing OpenCode${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo ""
    
    if [[ "$OS" == "windows" ]]; then
        npm install -g opencode-ai@latest
    else
        curl -fsSL https://opencode.ai/install | bash
    fi
    
    hash -r 2>/dev/null || true
    
    if check_command opencode; then
        echo -e "${GREEN}✓ OpenCode installed successfully${NC}"
        return 0
    else
        echo -e "${YELLOW}OpenCode installed. You may need to restart your terminal.${NC}"
        return 0
    fi
}

install_kilocode() {
    echo -e "\n${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}  Installing KiloCode CLI${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo ""
    
    echo -e "${BLUE}Installing via npm: @kilocode/cli${NC}"
    npm install -g @kilocode/cli
    
    hash -r 2>/dev/null || true
    
    if check_command kilo; then
        echo -e "${GREEN}✓ KiloCode CLI installed successfully${NC}"
        return 0
    else
        echo -e "${YELLOW}KiloCode CLI installed. You may need to restart your terminal.${NC}"
        return 0
    fi
}

# Upgrade existing installation
upgrade_opencode() {
    echo -e "\n${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}  Upgrading OpenCode${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo ""
    echo -e "${BLUE}Running: opencode upgrade${NC}"
    echo ""
    
    # Run upgrade and show output (don't capture, let it display)
    opencode upgrade || true
    
    echo ""
    echo -e "${GREEN}✓ OpenCode upgrade complete${NC}"
}

upgrade_kilocode() {
    echo -e "\n${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}  Upgrading KiloCode CLI${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo ""
    echo -e "${BLUE}Running: kilo upgrade${NC}"
    echo ""
    
    # Run upgrade and show output (don't capture, let it display)
    kilo upgrade || true
    
    echo ""
    echo -e "${GREEN}✓ KiloCode CLI upgrade complete${NC}"
}

# ============================================
# Dependency Check and Install Flow
# ============================================

check_and_install_dependencies() {
    local pkg_manager
    local missing_deps=()
    local needs_package_manager=false
    
    pkg_manager=$(detect_package_manager)
    
    echo -e "\n${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}  Dependency Check - ${OS}${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo ""
    
    # Check package manager (only for macos/windows)
    if [[ "$OS" == "macos" ]]; then
        if check_command brew; then
            print_status "Homebrew" "true" "$(get_version brew)" "true"
        else
            print_status "Homebrew" "false" "" "true"
            needs_package_manager=true
        fi
    elif [[ "$OS" == "windows" ]]; then
        if check_command winget; then
            print_status "winget" "true" "$(get_version winget)" "true"
        elif check_command choco; then
            print_status "Chocolatey" "true" "$(get_version choco)" "true"
        else
            print_status "winget/Chocolatey" "false" "" "true"
            needs_package_manager=true
        fi
    fi
    
    # Check Git
    if check_command git; then
        print_status "Git" "true" "$(get_version git)" "true"
    else
        print_status "Git" "false" "" "true"
        missing_deps+=("git")
    fi
    
    # Check npm (required for all platforms)
    if check_command npm; then
        print_status "npm/Node.js" "true" "$(get_version npm)" "true"
    else
        print_status "npm/Node.js" "false" "" "true"
        missing_deps+=("npm")
    fi
    
    # Check agent-browser
    if check_command agent-browser; then
        print_status "agent-browser" "true" "$(get_version agent-browser)" "true"
    else
        print_status "agent-browser" "false" "" "true"
        missing_deps+=("agent-browser")
    fi
    
    # Check OpenCode and KiloCode
    local has_opencode=false
    local has_kilo=false
    local has_old_kilo=false
    local has_new_kilo=false
    
    if check_command opencode; then
        print_status "OpenCode" "true" "$(get_version opencode)" "false"
        has_opencode=true
    else
        print_status "OpenCode" "false" "" "false"
    fi
    
    if check_command kilo; then
        print_status "KiloCode CLI" "true" "$(get_version kilo)" "false"
        has_kilo=true
        
        # Detect installation type (silently)
        if is_old_kilo_installation; then
            has_old_kilo=true
        elif is_new_kilo_installation; then
            has_new_kilo=true
        fi
    else
        print_status "KiloCode CLI" "false" "" "false"
    fi
    
    echo ""
    
    # Handle missing package manager
    if [[ "$needs_package_manager" == "true" ]]; then
        echo -e "${YELLOW}A package manager is required to install dependencies.${NC}"
        
        if [[ "$OS" == "macos" ]]; then
            prompt_read "Would you like to install Homebrew now? [Y/n]: " choice
            choice="${choice:-y}"
            
            if [[ "$choice" =~ ^[Yy] ]]; then
                install_homebrew || exit 1
                pkg_manager="brew"
            else
                echo -e "${RED}Cannot continue without Homebrew on macOS.${NC}"
                exit 1
            fi
        elif [[ "$OS" == "windows" ]]; then
            echo -e "${YELLOW}winget is not available. Chocolatey can be installed as an alternative.${NC}"
            prompt_read "Would you like instructions to install Chocolatey? [Y/n]: " choice
            choice="${choice:-y}"
            
            if [[ "$choice" =~ ^[Yy] ]]; then
                install_chocolatey || exit 1
                pkg_manager="choco"
            else
                echo -e "${RED}Cannot continue without a package manager on Windows.${NC}"
                exit 1
            fi
        fi
    fi
    
    # Install missing dependencies
    if [[ ${#missing_deps[@]} -gt 0 ]]; then
        echo ""
        echo -e "${YELLOW}The following dependencies are missing:${NC}"
        for dep in "${missing_deps[@]}"; do
            echo -e "  - ${dep}"
        done
        echo ""
        
        prompt_read "Would you like to install these automatically? [Y/n]: " choice
        choice="${choice:-y}"
        
        if [[ ! "$choice" =~ ^[Yy] ]]; then
            echo -e "${RED}Cannot continue without required dependencies.${NC}"
            exit 1
        fi
        
        for dep in "${missing_deps[@]}"; do
            case "$dep" in
                git)
                    install_git "$pkg_manager" || exit 1
                    ;;
                npm)
                    install_nodejs "$pkg_manager" || exit 1
                    ;;
                agent-browser)
                    if ! check_command npm; then
                        install_nodejs "$pkg_manager" || exit 1
                    fi
                    install_agent_browser || exit 1
                    ;;
            esac
        done
    fi
    
    # Handle OpenCode/KiloCode selection
    echo ""
    
    if [[ "$has_opencode" == "true" && "$has_kilo" == "true" ]]; then
        # Both installed - ask which to configure for
        echo -e "${GREEN}Both OpenCode and KiloCode CLI are installed.${NC}"
        echo ""
        echo -e "  ${BLUE}1)${NC} Configure for OpenCode"
        echo -e "  ${BLUE}2)${NC} Configure for KiloCode CLI"
        echo ""
        
        prompt_read "Choose [1-2, default: 1]: " choice
        choice="${choice:-1}"
        
        if [[ "$choice" == "2" ]]; then
            INSTALL_TYPE="kilo"
            # Handle old kilo installation
            if [[ "$has_old_kilo" == "true" ]]; then
                remove_old_kilo_installation
                install_kilocode || exit 1
            elif [[ "$has_new_kilo" == "true" ]]; then
                upgrade_kilocode
            fi
        else
            INSTALL_TYPE="opencode"
            upgrade_opencode
        fi
    elif [[ "$has_opencode" == "true" ]]; then
        # Only OpenCode installed
        echo -e "${GREEN}OpenCode is installed.${NC}"
        echo ""
        echo -e "  ${BLUE}1)${NC} Configure for OpenCode (already installed)"
        echo -e "  ${BLUE}2)${NC} Install KiloCode CLI and configure for that"
        echo ""
        
        prompt_read "Choose [1-2, default: 1]: " choice
        choice="${choice:-1}"
        
        if [[ "$choice" == "2" ]]; then
            install_kilocode || exit 1
            INSTALL_TYPE="kilo"
        else
            INSTALL_TYPE="opencode"
            upgrade_opencode
        fi
    elif [[ "$has_kilo" == "true" ]]; then
        # Only KiloCode installed
        echo -e "${GREEN}KiloCode CLI is installed.${NC}"
        echo ""
        echo -e "  ${BLUE}1)${NC} Configure for KiloCode CLI (already installed)"
        echo -e "  ${BLUE}2)${NC} Install OpenCode and configure for that"
        echo ""
        
        prompt_read "Choose [1-2, default: 1]: " choice
        choice="${choice:-1}"
        
        if [[ "$choice" == "2" ]]; then
            install_opencode || exit 1
            INSTALL_TYPE="opencode"
        else
            INSTALL_TYPE="kilo"
            # Handle old kilo installation
            if [[ "$has_old_kilo" == "true" ]]; then
                remove_old_kilo_installation
                install_kilocode || exit 1
            elif [[ "$has_new_kilo" == "true" ]]; then
                upgrade_kilocode
            fi
        fi
    else
        # Neither installed - ask which to install
        echo -e "${YELLOW}Neither OpenCode nor KiloCode CLI is installed.${NC}"
        echo ""
        echo -e "  ${BLUE}1)${NC} Install OpenCode"
        echo -e "  ${BLUE}2)${NC} Install KiloCode CLI"
        echo ""
        
        prompt_read "Choose [1-2, default: 1]: " choice
        choice="${choice:-1}"
        
        if [[ "$choice" == "2" ]]; then
            install_kilocode || exit 1
            INSTALL_TYPE="kilo"
        else
            install_opencode || exit 1
            INSTALL_TYPE="opencode"
        fi
    fi
    
    echo ""
    echo -e "${GREEN}All dependencies satisfied!${NC}"
}

# ============================================
# Model Selection
# ============================================

select_models() {
    local install_type="$1"
    
    if [[ "$install_type" == "kilo" ]]; then
        cat << 'EOF'
orchestrator=kilo/z-ai/glm-5
explorer=kilo/minimax/minimax-m2.5
oracle=kilo/anthropic/claude-sonnet-4.6
librarian=kilo/google/gemini-3-flash-preview
designer=kilo/google/gemini-3-flash-preview
fixer=kilo/minimax/minimax-m2.5
mapper=kilo/minimax/minimax-m2.5
default=kilo/minimax/minimax-m2.5
EOF
    else
        cat << 'EOF'
orchestrator=opencode/glm-5
explorer=opencode/minimax-m2.5
oracle=opencode/claude-sonnet-4-6
librarian=opencode/gemini-3-flash
designer=opencode/gemini-3-flash
fixer=opencode/minimax-m2.5
mapper=opencode/minimax-m2.5
default=opencode/minimax-m2.5
EOF
    fi
}

update_agent_models() {
    local config_dir="$1"
    local install_type="$2"
    
    local sed_flag
    sed_flag=$(get_sed_inplace_flag)
    
    if [[ "$install_type" == "kilo" ]]; then
        sed $sed_flag 's|^model: .*|model: kilo/z-ai/glm-5|' "$config_dir/agents/orchestrator.md"
        sed $sed_flag 's|^model: .*|model: kilo/minimax/minimax-m2.5|' "$config_dir/agents/explorer.md"
        sed $sed_flag 's|^model: .*|model: kilo/anthropic/claude-sonnet-4.6|' "$config_dir/agents/oracle.md"
        sed $sed_flag 's|^model: .*|model: kilo/google/gemini-3-flash-preview|' "$config_dir/agents/librarian.md"
        sed $sed_flag 's|^model: .*|model: kilo/google/gemini-3-flash-preview|' "$config_dir/agents/designer.md"
        sed $sed_flag 's|^model: .*|model: kilo/minimax/minimax-m2.5|' "$config_dir/agents/fixer.md"
        sed $sed_flag 's|^model: .*|model: kilo/minimax/minimax-m2.5|' "$config_dir/agents/mapper.md"
    else
        sed $sed_flag 's|^model: .*|model: opencode/glm-5|' "$config_dir/agents/orchestrator.md"
        sed $sed_flag 's|^model: .*|model: opencode/minimax-m2.5|' "$config_dir/agents/explorer.md"
        sed $sed_flag 's|^model: .*|model: opencode/claude-sonnet-4-6|' "$config_dir/agents/oracle.md"
        sed $sed_flag 's|^model: .*|model: opencode/gemini-3-flash|' "$config_dir/agents/librarian.md"
        sed $sed_flag 's|^model: .*|model: opencode/gemini-3-flash|' "$config_dir/agents/designer.md"
        sed $sed_flag 's|^model: .*|model: opencode/minimax-m2.5|' "$config_dir/agents/fixer.md"
        sed $sed_flag 's|^model: .*|model: opencode/minimax-m2.5|' "$config_dir/agents/mapper.md"
    fi
}

# ============================================
# Worktree Plugin
# ============================================

install_worktree_plugin() {
    echo -e "\n${BLUE}Installing OCX package manager...${NC}"
    
    # Install OCX
    if ! curl -fsSL https://ocx.kdco.dev/install.sh | sh; then
        echo -e "${RED}Failed to install OCX${NC}"
        return 1
    fi
    
    # Refresh PATH
    hash -r 2>/dev/null || true
    export PATH="$HOME/.local/bin:$PATH"
    
    # Verify OCX is available
    if ! command -v ocx &> /dev/null; then
        echo -e "${YELLOW}OCX installed but not in PATH. You may need to restart your terminal.${NC}"
        echo -e "${YELLOW}After restart, run:${NC}"
        echo -e "${YELLOW}  ocx init --global${NC}"
        echo -e "${YELLOW}  ocx registry add https://registry.kdco.dev --name kdco --global${NC}"
        echo -e "${YELLOW}  ocx add kdco/worktree --global${NC}"
        echo -e "${YELLOW}  cd ~/.config/opencode && bun install${NC}"
        return 0
    fi
    
    # Initialize OCX globally
    echo -e "${BLUE}Initializing OCX globally...${NC}"
    ocx init --global
    
    # Add KDCO registry globally (ignore if already exists)
    echo -e "${BLUE}Adding KDCO registry globally...${NC}"
    ocx registry add https://registry.kdco.dev --name kdco --global 2>/dev/null || true
    
    # Install worktree plugin globally (ignore if already installed)
    echo -e "${BLUE}Installing worktree plugin globally...${NC}"
    ocx add kdco/worktree --global 2>/dev/null || true
    
    # Install plugin dependencies
    local config_dir
    config_dir=$(get_config_dir "opencode" "$OS")
    
    if [[ -f "$config_dir/package.json" ]]; then
        echo -e "${BLUE}Installing plugin dependencies...${NC}"
        
        # Fix potentially incorrect version in package.json
        # OCX may generate a version that doesn't exist yet
        local pkg_file="$config_dir/package.json"
        if grep -q '"@opencode-ai/plugin"' "$pkg_file" 2>/dev/null; then
            # Get latest available version and update package.json
            local latest_version
            latest_version=$(npm view @opencode-ai/plugin version 2>/dev/null || echo "1.2.12")
            sed 's/"@opencode-ai\/plugin": "[^"]*"/"@opencode-ai\/plugin": "'"$latest_version"'"/' "$pkg_file" > "$pkg_file.tmp" && mv "$pkg_file.tmp" "$pkg_file" 2>/dev/null || true
        fi
        
        # Prefer bun if available (faster), otherwise use npm
        if command -v bun &> /dev/null; then
            (cd "$config_dir" && bun install)
        elif command -v npm &> /dev/null; then
            (cd "$config_dir" && npm install)
        else
            echo -e "${YELLOW}Neither bun nor npm found. Please install dependencies manually:${NC}"
            echo -e "${YELLOW}  cd $config_dir && npm install${NC}"
        fi
    fi
    
    echo -e "${GREEN}✓ Worktree plugin installed!${NC}"
}

prompt_worktree_plugin() {
    echo -e "\n${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}  Worktree Plugin${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo ""
    echo "Enables parallel AI agents working on the same project"
    echo "without conflicts - each in its own isolated environment."
    echo ""
    prompt_read "Install worktree plugin? [y/N]: " install_plugin
    install_plugin="${install_plugin:-n}"
    
    if [[ "$install_plugin" =~ ^[Yy] ]]; then
        install_worktree_plugin
    fi
}

generate_config() {
    local models="$1"
    local config_dir="$2"
    local install_type="$3"
    
    local model_prefix="opencode"
    if [[ "$install_type" == "kilo" ]]; then
        model_prefix="kilo"
    fi
    
    local exa_header="\"x-api-key\": \"\""
    local context7_header='"CONTEXT7_API_KEY": ""'
    
    template=$(cat << TPLATE
{
  "\$schema": "https://opencode.ai/config.json",
  "default_agent": "orchestrator",
  "model": "${model_prefix}/minimax-m2.5",
  "mcp": {
    "websearch": {
      "type": "remote",
      "url": "https://mcp.exa.ai/mcp?tools=web_search_exa",
      "headers": {
        $exa_header
      }
    },
    "context7": {
      "type": "remote",
      "url": "https://mcp.context7.com/mcp",
      "headers": {
        $context7_header
      }
    },
    "grep_app": {
      "type": "remote",
      "url": "https://mcp.grep.app"
    }
  },
  "tools": {
    "websearch_*": false,
    "context7_*": false,
    "grep_app_*": false
  }
}
TPLATE
)
    
    echo "$template"
}

# ============================================
# Main Installation
# ============================================

install() {
    local config_dir models
    
    parse_args "$@"
    
    OS=$(detect_os)
    echo -e "${GREEN}Detected OS: ${OS}${NC}"
    
    check_and_install_dependencies
    
    config_dir=$(get_config_dir "$INSTALL_TYPE" "$OS")
    echo -e "${GREEN}Config directory: ${config_dir}${NC}"
    
    mkdir -p "$config_dir"
    
    local json_backup=""
    if [[ -f "$config_dir/opencode.json" ]]; then
        json_backup="${config_dir}/opencode.json.backup.$(date +%Y%m%d_%H%M%S)"
        cp "$config_dir/opencode.json" "$json_backup"
    fi
    
    echo -e "\n${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}  Downloading OpenKiloCode Configuration${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo ""
    
    if command -v git &> /dev/null; then
        git clone --depth 1 --branch "$REPO_BRANCH" "$REPO_URL" /tmp/openkilocode 2>&1 || {
            echo -e "${RED}Failed to clone repository${NC}"
            exit 1
        }
        
        rm -rf "$config_dir/agents" "$config_dir/skills" 2>/dev/null || true
        cp -r /tmp/openkilocode/{agents,skills} "$config_dir/" 2>/dev/null || true
        rm -rf /tmp/openkilocode
    else
        echo -e "${RED}Git is required for installation${NC}"
        exit 1
    fi
    
    models=$(select_models "$INSTALL_TYPE")
    
    echo -e "${BLUE}Updating agent models...${NC}"
    update_agent_models "$config_dir" "$INSTALL_TYPE"
    
    echo -e "${BLUE}Generating configuration...${NC}"
    generate_config "$models" "$config_dir" "$INSTALL_TYPE" > "$config_dir/opencode.json"
    
    if [[ -n "$json_backup" ]]; then
        echo -e "${YELLOW}Note: Backed up opencode.json to $(basename "$json_backup")${NC}"
    fi
    
    echo -e "\n${GREEN}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}  ✓ OpenKiloCode installed successfully!${NC}"
    echo -e "${GREEN}═══════════════════════════════════════════════════════════${NC}"
    echo ""
    echo -e "Config location: ${CYAN}${config_dir}${NC}"
    echo ""
    echo -e "${BLUE}Agents:${NC}"
    echo "  * orchestrator - Primary agent with delegation"
    echo "  * explorer     - Codebase search"
    echo "  * oracle       - Architecture advisor"
    echo "  * librarian    - Documentation research"
    echo "  * designer     - UI/UX specialist"
    echo "  * fixer        - Implementation specialist"
    echo "  * mapper       - Repository mapping"
    echo ""
    
    if [[ "$INSTALL_TYPE" == "kilo" ]]; then
        echo -e "${YELLOW}Run 'kilo' to start!${NC}"
    else
        echo -e "${YELLOW}Run 'opencode' to start!${NC}"
    fi
    
    # Ask about worktree plugin after main installation
    prompt_worktree_plugin
    
    if [[ -n "$json_backup" && -f "$json_backup" ]]; then
        prompt_read "Delete opencode.json backup? [y/N]: " delete_backup
        delete_backup="${delete_backup:-n}"
        if [[ "$delete_backup" =~ ^[Yy] ]]; then
            rm -f "$json_backup"
            echo -e "${GREEN}Backup deleted.${NC}"
        fi
    fi
}

# ============================================
# Entry Point
# ============================================

main() {
    echo -e "${CYAN}"
    cat << 'BANNER'                                                                              
                                                                           
                                                                            
▄████▄ ▄▄▄▄  ▄▄▄▄▄ ▄▄  ▄▄ ██ ▄█▀ ▄▄ ▄▄     ▄▄▄  ▄█████  ▄▄▄  ▄▄▄▄  ▄▄▄▄▄ 
██  ██ ██▄█▀ ██▄▄  ███▄██ ████   ██ ██    ██▀██ ██     ██▀██ ██▀██ ██▄▄  
▀████▀ ██    ██▄▄▄ ██ ▀██ ██ ▀█▄ ██ ██▄▄▄ ▀███▀ ▀█████ ▀███▀ ████▀ ██▄▄▄ 
                                                                           
                                                                                                                                 
BANNER
    echo -e "${NC}"
    
    install "$@"
}

main "$@"

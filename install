#!/usr/bin/env bash
#
# OpenKiloCode Installer
# Multi-agent configuration for OpenCode
#
# Usage:
#   curl -fsSL https://raw.githubusercontent.com/skogstatarzan/openkilocode/main/install | bash
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Default values
REPO_URL="https://github.com/skogstatarzan/openkilocode"
REPO_BRANCH="main"
USE_DEFAULTS=true
CUSTOM_MODELS=""
INSTALL_TYPE="opencode"  # "opencode" or "kilo"
EXA_API_KEY=""
CONTEXT7_API_KEY=""

# Check if running interactively
is_interactive() {
    [[ -t 0 ]]
}

# ============================================
# OS Detection
# ============================================

detect_os() {
    case "$(uname -s)" in
        Linux*)     OS="linux" ;;
        Darwin*)    OS="macos" ;;
        CYGWIN*)    OS="windows" ;;
        MINGW*)     OS="windows" ;;
        MSYS*)      OS="windows" ;;
        *)          OS="linux" ;;
    esac
    
    # Check for WSL
    if [[ "$OS" == "linux" ]] && grep -qi microsoft /proc/version 2>/dev/null; then
        OS="wsl"
    fi
    
    echo "$OS"
}

# ============================================
# Detect sed flag for in-place editing (macOS vs GNU)
# ============================================

get_sed_inplace_flag() {
    if [[ "$(uname -s)" == "Darwin" ]]; then
        echo "-i ''"
    else
        echo "-i"
    fi
}

# ============================================
# Config Path Detection
# ============================================

get_config_dir() {
    local install_type="$1"
    local os="$2"
    
    case "$os" in
        linux|wsl|macos)
            if [[ "$install_type" == "kilo" ]]; then
                if [[ -n "$XDG_CONFIG_HOME" ]]; then
                    echo "$XDG_CONFIG_HOME/kilo"
                else
                    echo "$HOME/.config/kilo"
                fi
            else
                if [[ -n "$XDG_CONFIG_HOME" ]]; then
                    echo "$XDG_CONFIG_HOME/opencode"
                else
                    echo "$HOME/.config/opencode"
                fi
            fi
            ;;
        windows)
            if [[ "$install_type" == "kilo" ]]; then
                echo "$APPDATA/kilo"
            else
                echo "$APPDATA/opencode"
            fi
            ;;
        *)
            if [[ "$install_type" == "kilo" ]]; then
                echo "$HOME/.config/kilo"
            else
                echo "$HOME/.config/opencode"
            fi
            ;;
    esac
}

# ============================================
# Argument Parsing (for backward compatibility)
# ============================================

parse_args() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --defaults|-d)
                USE_DEFAULTS=true
                shift
                ;;
            --models|-m)
                USE_DEFAULTS=false
                CUSTOM_MODELS="$2"
                shift 2
                ;;
            --non-interactive|-y)
                # Keep using defaults in non-interactive mode
                shift
                ;;
            --help|-h)
                show_help
                exit 0
                ;;
            *)
                echo -e "${RED}Unknown option: $1${NC}"
                show_help
                exit 1
                ;;
        esac
    done
}

show_help() {
    cat << EOF
OpenKiloCode Installer

Usage:
  curl -fsSL <url>/install | bash

Options:
  -d, --defaults          Use default models (default behavior)
  -m, --models MODELS     Specify custom models (format: agent=model,agent=model)
  -y, --non-interactive   Non-interactive mode (use defaults)
  -h, --help              Show this help message

Examples:
  # Interactive installation (will prompt for choices)
  curl -fsSL https://raw.githubusercontent.com/skogstatarzan/openkilocode/main/install | bash

  # Use default models
  curl -fsSL ... | bash -s -- --defaults

  # Specify custom models
  curl -fsSL ... | bash -s -- --models "orchestrator=opencode/gpt-5.1-codex,fixer=opencode/gemini-3-flash"
EOF
}

# ============================================
# Interactive Prompts
# ============================================

prompt_install_type() {
    # Use defaults if not interactive
    if ! is_interactive; then
        echo -e "${YELLOW}Running in non-interactive mode. Using defaults: OpenCode${NC}"
        INSTALL_TYPE="opencode"
        return
    fi
    
    echo -e "\n${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}  Installation Type${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo ""
    echo -e "  ${BLUE}1)${NC} OpenCode      → Config: ~/.config/opencode"
    echo -e "  ${BLUE}2)${NC} KiloCode CLI   → Config: ~/.config/kilo"
    echo ""
    
    while true; do
        read -rp "$(echo -e "${GREEN}Choose [1-2, default: 1]: ${NC}")" choice
        choice="${choice:-1}"
        
        case "$choice" in
            1)
                INSTALL_TYPE="opencode"
                break
                ;;
            2)
                INSTALL_TYPE="kilo"
                break
                ;;
            *)
                echo -e "${YELLOW}Please enter 1 or 2${NC}"
                ;;
        esac
    done
    
    # Show gateway info and wait for Enter
    echo ""
    if [[ "$INSTALL_TYPE" == "kilo" ]]; then
        echo -e "${YELLOW}→ Connect to Kilo Gateway for default models to work${NC}"
    else
        echo -e "${YELLOW}→ Connect to OpenCode Zen for default models to work${NC}"
    fi
    echo -e "${YELLOW}→ You can do this after installation if needed${NC}"
    echo ""
    read -rp "Press Enter to continue..."
    
    echo ""
    if [[ "$INSTALL_TYPE" == "kilo" ]]; then
        echo -e "${YELLOW}add API keys to ~/.config/kilo/opencode.json if experiencing problems${NC}"
    else
        echo -e "${YELLOW}add API keys to ~/.config/opencode/opencode.json if experiencing problems${NC}"
    fi
}

# ============================================
# Get Available Models from OpenCode
# ============================================

get_available_models() {
    if command -v opencode &> /dev/null; then
        opencode models --list 2>/dev/null | grep -E "^[a-z]" | head -50 || echo ""
    else
        echo ""
    fi
}

# ============================================
# Model Selection (updates agent markdown files)
# ============================================

select_models() {
    local install_type="$1"
    
    if [[ "$install_type" == "kilo" ]]; then
        cat << 'EOF'
orchestrator=kilo/z-ai/glm-5
explorer=kilo/minimax/minimax-m2.5
oracle=kilo/anthropic/claude-sonnet-4.6
librarian=kilo/google/gemini-3-flash-preview
designer=kilo/google/gemini-3-flash-preview
fixer=kilo/minimax/minimax-m2.5
mapper=kilo/minimax/minimax-m2.5
default=kilo/minimax/minimax-m2.5
EOF
    else
        cat << 'EOF'
orchestrator=opencode/glm-5
explorer=opencode/minimax-m2.5
oracle=opencode/claude-sonnet-4-6
librarian=opencode/gemini-3-flash
designer=opencode/gemini-3-flash
fixer=opencode/minimax-m2.5
mapper=opencode/minimax-m2.5
default=opencode/minimax-m2.5
EOF
    fi
}

# ============================================
# Update agent markdown files with correct models
# ============================================

update_agent_models() {
    local config_dir="$1"
    local install_type="$2"
    
    local sed_flag
    sed_flag=$(get_sed_inplace_flag)
    
    if [[ "$install_type" == "kilo" ]]; then
        sed $sed_flag 's|^model: .*|model: kilo/z-ai/glm-5|' "$config_dir/agents/orchestrator.md"
        sed $sed_flag 's|^model: .*|model: kilo/minimax/minimax-m2.5|' "$config_dir/agents/explorer.md"
        sed $sed_flag 's|^model: .*|model: kilo/anthropic/claude-sonnet-4.6|' "$config_dir/agents/oracle.md"
        sed $sed_flag 's|^model: .*|model: kilo/google/gemini-3-flash-preview|' "$config_dir/agents/librarian.md"
        sed $sed_flag 's|^model: .*|model: kilo/google/gemini-3-flash-preview|' "$config_dir/agents/designer.md"
        sed $sed_flag 's|^model: .*|model: kilo/minimax/minimax-m2.5|' "$config_dir/agents/fixer.md"
        sed $sed_flag 's|^model: .*|model: kilo/minimax/minimax-m2.5|' "$config_dir/agents/mapper.md"
    else
        sed $sed_flag 's|^model: .*|model: opencode/glm-5|' "$config_dir/agents/orchestrator.md"
        sed $sed_flag 's|^model: .*|model: opencode/minimax-m2.5|' "$config_dir/agents/explorer.md"
        sed $sed_flag 's|^model: .*|model: opencode/claude-sonnet-4-6|' "$config_dir/agents/oracle.md"
        sed $sed_flag 's|^model: .*|model: opencode/gemini-3-flash|' "$config_dir/agents/librarian.md"
        sed $sed_flag 's|^model: .*|model: opencode/gemini-3-flash|' "$config_dir/agents/designer.md"
        sed $sed_flag 's|^model: .*|model: opencode/minimax-m2.5|' "$config_dir/agents/fixer.md"
        sed $sed_flag 's|^model: .*|model: opencode/minimax-m2.5|' "$config_dir/agents/mapper.md"
    fi
}

# ============================================
# Generate Config (without agent block - agents in markdown)
# ============================================

generate_config() {
    local models="$1"
    local config_dir="$2"
    local install_type="$3"
    
    # Adjust model prefix based on install type
    local model_prefix="opencode"
    if [[ "$install_type" == "kilo" ]]; then
        model_prefix="kilo"
    fi
    
    # API keys are empty by default - user can add them manually if needed
    local exa_header="\"x-api-key\": \"\""
    local context7_header='"CONTEXT7_API_KEY": ""'
    
    template=$(cat << TPLATE
{
  "\$schema": "https://opencode.ai/config.json",
  "default_agent": "orchestrator",
  "model": "${model_prefix}/minimax-m2.5",
  "mcp": {
    "websearch": {
      "type": "remote",
      "url": "https://mcp.exa.ai/mcp?tools=web_search_exa",
      "headers": {
        $exa_header
      }
    },
    "context7": {
      "type": "remote",
      "url": "https://mcp.context7.com/mcp",
      "headers": {
        $context7_header
      }
    },
    "grep_app": {
      "type": "remote",
      "url": "https://mcp.grep.app"
    }
  },
  "tools": {
    "websearch_*": false,
    "context7_*": false,
    "grep_app_*": false
  }
}
TPLATE
)
    
    echo "$template"
}

# ============================================
# Main Installation
# ============================================

install() {
    local os config_dir models
    
    # Detect OS
    os=$(detect_os)
    echo -e "${GREEN}Detected OS: ${os}${NC}"
    
    # Parse command line args first (for backward compatibility)
    parse_args "$@"
    
    # Interactive prompts
    prompt_install_type
    
    # Get config directory
    config_dir=$(get_config_dir "$INSTALL_TYPE" "$os")
    echo -e "${GREEN}Config directory: ${config_dir}${NC}"
    
    # Check if OpenCode/Kilo is installed
    if [[ "$INSTALL_TYPE" == "kilo" ]]; then
        if ! command -v kilo &> /dev/null; then
            echo -e "${YELLOW}Warning: KiloCode CLI is not installed or not in PATH${NC}"
            echo -e "${YELLOW}Install KiloCode CLI first${NC}"
        fi
    else
        if ! command -v opencode &> /dev/null; then
            echo -e "${YELLOW}Warning: OpenCode is not installed or not in PATH${NC}"
            echo -e "${YELLOW}Install OpenCode first: https://opencode.ai${NC}"
        fi
    fi
    
    # Create config directory if needed
    mkdir -p "$config_dir"
    
    # Backup opencode.json if it exists (for update)
    local json_backup=""
    if [[ -f "$config_dir/opencode.json" ]]; then
        json_backup="${config_dir}/opencode.json.backup.$(date +%Y%m%d_%H%M%S)"
        cp "$config_dir/opencode.json" "$json_backup"
    fi
    
    # Download repo
    echo -e "${GREEN}Downloading OpenKiloCode...${NC}"
    
    if command -v git &> /dev/null; then
        git clone --depth 1 --branch "$REPO_BRANCH" "$REPO_URL" /tmp/openkilocode 2>&1 || {
            echo -e "${RED}Failed to clone repository${NC}"
            exit 1
        }
        
        # Remove repo-managed files (will be replaced with fresh copies)
        rm -rf "$config_dir/agents" "$config_dir/skills" 2>/dev/null || true
        
        # Copy files (excluding .git and install script)
        cp -r /tmp/openkilocode/{agents,skills} "$config_dir/" 2>/dev/null || true
        rm -rf /tmp/openkilocode
    else
        echo -e "${RED}Git is required for installation${NC}"
        exit 1
    fi
    
    # Select models based on install type
    models=$(select_models "$INSTALL_TYPE")
    
    # Update agent markdown files with correct model names
    echo -e "${GREEN}Updating agent models...${NC}"
    update_agent_models "$config_dir" "$INSTALL_TYPE"
    
    # Generate config (without agent block - agents in markdown)
    echo -e "${GREEN}Generating configuration...${NC}"
    generate_config "$models" "$config_dir" "$INSTALL_TYPE" > "$config_dir/opencode.json"
    
    # Notify about backup if it exists
    if [[ -n "$json_backup" ]]; then
        echo -e "${YELLOW}Note: Backed up opencode.json to $(basename "$json_backup")${NC}"
        echo -e "${YELLOW}Review it if you had custom configs you want to keep.${NC}"
    fi
    
    # Success message
    echo -e "\n${GREEN}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}  ✓ OpenKiloCode installed successfully!${NC}"
    echo -e "${GREEN}═══════════════════════════════════════════════════════════${NC}"
    echo ""
    echo -e "Config location: ${CYAN}${config_dir}${NC}"
    echo ""
    echo -e "${BLUE}Agents (in agents/*.md):${NC}"
    echo "  * orchestrator - Primary agent with delegation"
    echo "  * explorer     - Codebase search"
    echo "  * oracle       - Architecture advisor"
    echo "  * librarian    - Documentation research"
    echo "  * designer     - UI/UX specialist"
    echo "  * fixer        - Implementation specialist"
    echo "  * mapper       - Repository mapping"
    echo ""
    echo -e "${BLUE}MCP Servers:${NC}"
    echo "  * websearch  - Web search - add API key to config if needed"
    echo "  * context7   - Docs lookup - add API key to config if needed"
    echo "  * grep_app   - GitHub code search"
    echo ""
    
    if [[ "$INSTALL_TYPE" == "kilo" ]]; then
        echo -e "${YELLOW}Run 'kilo' to start!${NC}"
    else
        echo -e "${YELLOW}Run 'opencode' to start!${NC}"
    fi
    
    # Offer to delete install script
    if [[ -n "$0" && "$0" != "-" && -f "$0" ]]; then
        echo ""
        read -rp "Delete install script? [Y/n]: " delete_choice
        delete_choice="${delete_choice:-y}"
        if [[ "$delete_choice" =~ ^[Yy] ]]; then
            rm -f "$0"
            echo -e "${GREEN}Install script deleted.${NC}"
        fi
    fi
    
    # Offer to delete opencode.json backup if it exists
    if [[ -n "$json_backup" && -f "$json_backup" ]]; then
        echo ""
        read -rp "Delete opencode.json backup? [y/N]: " delete_backup
        delete_backup="${delete_backup:-n}"
        if [[ "$delete_backup" =~ ^[Yy] ]]; then
            rm -f "$json_backup"
            echo -e "${GREEN}Backup deleted.${NC}"
        fi
    fi
}

# ============================================
# Entry Point
# ============================================

main() {
    echo -e "${CYAN}"
    cat << 'BANNER'                                                                              
                                                                         
                                                                          
▄████▄ ▄▄▄▄  ▄▄▄▄▄ ▄▄  ▄▄ ██ ▄█▀ ▄▄ ▄▄     ▄▄▄  ▄█████  ▄▄▄  ▄▄▄▄  ▄▄▄▄▄ 
██  ██ ██▄█▀ ██▄▄  ███▄██ ████   ██ ██    ██▀██ ██     ██▀██ ██▀██ ██▄▄  
▀████▀ ██    ██▄▄▄ ██ ▀██ ██ ▀█▄ ██ ██▄▄▄ ▀███▀ ▀█████ ▀███▀ ████▀ ██▄▄▄ 
                                                                         
                                                                                                                               
BANNER
    echo -e "${NC}"
    
    install "$@"
}

main "$@"
